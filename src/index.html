<!DOCTYPE html>
<html>
	<head>
        <link rel="import" href="./userModules/export-level.html">
        <link rel="import" href="./userModules/import-level.html">
        <link rel="import" href="./userModules/tool-bar.html">
		
		<link rel="import" href="./bower_components/paper-button/paper-button.html">
		<link rel="import" href="./bower_components/paper-checkbox/paper-checkbox.html">
		<link rel="import" href="./bower_components/paper-dialog/paper-dialog.html">
		<link rel="import" href="./bower_components/paper-radio-button/paper-radio-button.html">
		<link rel="import" href="./bower_components/paper-radio-group/paper-radio-group.html">
		<link rel="import" href="./bower_components/paper-icon-button/paper-icon-button.html">
		<link rel="import" href="./bower_components/paper-input/paper-input.html">
		<link rel="import" href="./bower_components/paper-input/paper-textarea.html">
		<link rel="import" href="./bower_components/iron-icons/iron-icons.html">
		<script src="./js/lvl.js"></script>
		<script src="./js/popupManager.js"></script>
        
		<script>
			//Electron code
			const greenworks = require('greenworks');
			const path = require('path');
			const process = require('process');
			const remote = require('electron').remote;
			const srcDir = process.cwd();
			console.log('srcDir: ' + srcDir);
			process.activateUvLoop();
			const fs = require('fs');
			
			window.onerror = function (errorMsg, url, lineNumber) {
               alert(errorMsg + lineNumber);
               // alert("This is a stack trace! Wow! --> %s", error.stack);
            };
			
			//var path = remote.getGlobal('path');
			//console.log(path);
			//console.log(__dirname);
			
			/*console.log = function(data){
				alert(data); //Comment out of relese build
			}*/
				
			let steam = false;
			if(greenworks.initAPI()){
				console.log('Steamworks API Initialized');
				steam = true;
			
				let steamworksWorkshopSyncPath = path.resolve(srcDir, 'game/Levels');
				greenworks.ugcSynchronizeItems(steamworksWorkshopSyncPath, function(items){
					console.log('Workshop Items Loaded: ');
					console.log(items);
				}, function(err){
					throw err;
				});
			}else{
				console.log('Steamworks API Initialization Failed');
			}
			
			//Legacy browser code
			const level = new lvl('build');
			var darkbox;
			var gridbox;
			var mngr;
			
			function generateImportView(){
				return new ImportLevel(mngr);
			}
			
			let exportWindow = {};
			window.onload = function(){
				mngr = new popupManager();
				document.getElementById('placeholder').appendChild(level.generateBoard());
				
				darkbox = document.getElementById('dark');
				gridbox = document.getElementById('gridbox');
				darkbox.onchange = function(){
					level.setDark(!level.setDarkdark);
				}
				gridbox.onchange = function(){
					if(gridbox.checked){
						level.enableGrid();
					}else{
						level.disableGrid();
					}
				}
				
				exportWindow.main = document.getElementById('export');
				exportWindow.dev = document.getElementById('export-dev');
				exportWindow.dev.num = document.getElementById('export-dev-num');
				exportWindow.dev.button = document.getElementById('export-dev-button');
				exportWindow.dev.titleBox = document.getElementById('export-dev-title');
				exportWindow.steam = document.getElementById('export-steam');
				exportWindow.steam.title = document.getElementById('export-steam-title');
				exportWindow.steam.button = document.getElementById('export-steam-button');
				
				if(!steam){
					exportWindow.steam.button.setAttribute('disabled', '');
				}
				
				exportWindow.closeAll = function(){
					exportWindow.main.close();
					exportWindow.steam.close();
					exportWindow.dev.close();
				}
				
				exportWindow.dev.saveFile = function(){
					let num = exportWindow.dev.num.value || 'x';
					let data = level.exportDev(num);
					remote.dialog.showSaveDialog({defaultPath: srcDir + '/' + exportWindow.dev.titleBox.value + '.txt'}, function(path){
						if(path){
							fs.writeFile(path, data, function(err){
								if(err){
									throw err;
								}else{
									console.log("File Saved!");
									exportWindow.closeAll();
								}
							});
						}
					});
				}
				
				exportWindow.steam.upload = function(){
					let title = document.getElementById('export-steam-title').value; //TODO: Validate param
					let description = ''; //TODO: Get description
					
					let levelpath = 'levels/' + title + '.txt';
					let levelUploadPath = title + '.txt'
					let coverPath = 'levels/' + title + '.png'; //TODO: Cover images
					let levelData = level.exportLBL();
					
					function createLevelsFolder(){
						return new Promise(function(resolve, reject){
							fs.stat('levels', function(err, stats){
								err = err || {};
								if(err.code === 'ENOENT'){
									console.log('Levels Folder Not Found: Possible loss of data');
									fs.mkdir('levels', function(err){
										if(err){
											throw err;
										}else{
											resolve();
											onLevelsFolder(levelUploadPath, data, title);
										}
									});
								}else{
									resolve(); //TODO: Logic of cahced files
								}
							});
						});
					}
					
					function createSteamFile(path, data){
						return new Promise(function(resolve, reject){
							if(!greenworks.isCloudEnabledForUser()){
								reject("Cloud disabled by user, workshop disabled");
							}
							if(!greenworks.isCloudEnabled()){
								reject("Cloud disabled by game, workshop disabled");
							}
							greenworks.saveTextToFile(path, data, function(){
								resolve();
							},
							function(err){
								reject(err);
							});
						});
					}
					
					function shareSteamFile(path){
						return new Promise(function(resolve, reject){
							greenworks.fileShare(path, function(){
								resolve();
							}, function(err){
								reject(err);
							});
						});
					}
					
					function publishToWorkshop(levelUploadPath, imageUploadPath, title, description){
						return new Promise(function(resolve, reject){
							greenworks.publishWorkshopFile(levelUploadPath, imageUploadPath, title, description, function(handle){
								resolve(handle);
							}, function(err){
								throw err;
							});
						});
					}
					
					createLevelsFolder().catch(function(err){
						throw err;
					}).then(function(){
						return createSteamFile(levelUploadPath, levelData);
					}).catch(function(err){
						throw err;
					}).then(function(){
						console.log('Level File Uploaded');
						return shareSteamFile(levelUploadPath);
					}).catch(function(err){
						throw err;
					}).then(function(){
						console.log('Level File Shared');
						return publishToWorkshop(levelUploadPath, '', title, description);
					}).catch(function(err){
						throw err;
					}).then(function(handle){
						console.log('Workshop handle: ' + handle); //1183789806
						console.log('File Published');
					});
				}
			}

			function openExportPopup(){
				mngr.openPopup(generateExportView());
			}

			function openImportPopup(){
				mngr.openPopup(generateImportView());
			}

			function importlvl1D(){
				var data = document.getElementById('interface').value;
				level.import1D(data);
			}
			/*window.ondragstart = function(){
				return false;
			}*/
           
			level.ondarkchange = function(value){
				darkbox.checked = value;
			}
            /*var resizeTarget;
            function startResize(e){
                window.addEventListener('mousemove', resize, false);
                window.addEventListener('mouseup', endResize, false);
                resizeTarget = e.target.parentNode;
                console.log(e);
            }
            function resize(e){
                resizeTarget.style.width = (e.clientX - resizeTarget.offsetLeft) + 'px';
                console.log(e);
                console.log(resizeTarget.width);
            }
            function endResize(){
            
            }  */
		</script>
		<!--<style>
			* {
    				-webkit-touch-callout:none;
    				-webkit-user-select:none;
  				    -moz-user-select:none;
    				-ms-user-select:none;
    				user-select:none;
			}
		</style>-->
		<style is="custom-style">
				paper-button.export{
					background-color: #FF0000;
					--paper-button-ink-color: #303030;
					color: #000000;
				}	
				paper-button.import{
					background-color: #FF0000;
					--paper-button-ink-color: #303030;
					color: #000000;
				}
				paper-toggle-button.grid{
					--paper-toggle-button-checked-bar-color: #FF0000;
					--paper-toggle-button-checked-button-color: #FF0000;
				}
		</style>
	</head>
	<body style="background-color: #303030">
		    <tool-bar style="z-index: -1;"></tool-bar>
			<div id="placeholder" style="">
                <!--<div style="width:10px;height:10px;border-radius: 5px; background-color: blue; position: absolute; bottom: 25px; right: 180px;" onmousedown="startResize(event);"></div>-->
            </div>
			<div style="width:800px; bottom:-20px; position:relative; background-color: #777777; border: 2px solid black; height: 50px; border-radius: 50px;">
				<paper-button raised onclick="exportWindow.main.open()" class = "export" style="position:absolute; top:5px; height: 40px; left:25px;">Export</paper-button>
				<paper-button raised onclick="openImportPopup()" class = "import" style="position:absolute; top:5px; height: 40px; left:125px;">Import</paper-button>
				<paper-toggle-button id="gridbox" style="left: 225px;position:absolute;top:5px; height: 40px;" class="grid" checked>Enable Grid</paper-toggle-button>
			</div>
            <div style="outline:2px solid; width:800px; bottom:-40px; position:relative; background-color: white;">
				<textarea id="interface" style="width:400px"></textarea>
				<input id="dark" type="checkbox">Dark
			</div>
			<paper-dialog modal id="export">
				<div>
					<paper-icon-button icon="close" style="top:0px;position:absolute;left:0px;" onclick="exportWindow.main.close()"></paper-icon-button>
				</div>
				<div style="padding-top: 10px;">
					<h1>Export Options</h1>
					<paper-button raised onclick="exportWindow.steam.open()" id="export-steam-button">Steam Workshop</paper-button>
					<paper-button raised onclick="exportWindow.dev.open()" id="export-dev-button">Dev Export</paper-button>
				</div>
			</paper-dialog>
			<paper-dialog modal id="export-dev" style="width:100%; height:100%; top:0px;">
				<div>
					<paper-icon-button icon="close" style="top:0px;position:absolute;left:0px;" onclick="exportWindow.closeAll()"></paper-icon-button>
				</div>
				<div style="padding-top: 10px;">
					<h1>Developer Export</h1>
					<paper-input label="Level Title" id="export-dev-title" value="myLevel"></paper-input>
					<paper-input label="Level Number" id="export-dev-num" type="number"></paper-input>
					<paper-button raised style="width: 100px;" onclick="exportWindow.dev.saveFile()">Save</paper-button>
				</div>
			</paper-dialog>
			<paper-dialog modal id="export-steam" style="width:100%; height:100%; top:0px;">
				<div>
					<paper-icon-button icon="close" style="top:0px;position:absolute;left:0px;" onclick="exportWindow.closeAll()"></paper-icon-button>
				</div>
				<div style="padding-top: 10px;">
					<h1>Steam Workshop Upload</h1>
					<paper-input label="Level Title" id="export-steam-title"></paper-input>
					<paper-textarea label="Description"></paper-textarea>
					<paper-button raised style="width: 100px;" onclick="exportWindow.steam.upload()">Upload</paper-button>
				</div>
			</paper-dialog>
		</div>
	</body>
</html>
